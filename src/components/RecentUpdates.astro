---
import { getCollection } from "astro:content";

type BaseItem = {
  title: string;
  description: string;
  href: string;
  isRecent: boolean;
};

type NoteItem = BaseItem & {
  date: Date;
};

type ProjectItem = BaseItem & {
  date: Date | null;
};

type ToastItem = BaseItem & {
  date: Date | null;
  kind: "Writing" | "Project";
};

const MAX_ITEMS = 3;
const MAX_TOASTS = 5;
const RECENT_WINDOW_DAYS = 30;
const AUTO_DISMISS_MS = 16000;
const STAGGER_MS = 450;

const now = new Date();
const cutoff = new Date(now);
cutoff.setDate(now.getDate() - RECENT_WINDOW_DAYS);

const notes = await getCollection("notes");
const projects = await getCollection("projects");

const noteItems: NoteItem[] = notes.map((entry) => ({
  title: entry.data.title,
  description: entry.data.description,
  href: `/writing/${entry.id}/`,
  date: entry.data.publicationDate,
  isRecent: entry.data.publicationDate >= cutoff,
}));

const projectItems: ProjectItem[] = projects.map((entry) => {
  const date = entry.data.publicationDate ?? null;
  return {
    title: entry.data.title,
    description: entry.data.description,
    href: entry.data.href,
    date,
    isRecent: date ? date >= cutoff : false,
  };
});

const selectRecentItems = <T extends { date: Date | null }>(
  items: T[],
): T[] => {
  const datedItems = items.filter(
    (item): item is T & { date: Date } => item.date instanceof Date,
  );
  if (datedItems.length === 0) {
    return items.slice(0, MAX_ITEMS);
  }

  const sorted = [...datedItems].sort(
    (a, b) => b.date.valueOf() - a.date.valueOf(),
  );
  const [latest, ...rest] = sorted;
  const recent = rest.filter((item) => item.date >= cutoff);

  return [latest, ...recent].slice(0, MAX_ITEMS);
};

const recentNotes = selectRecentItems(noteItems);
const datedProjects = projectItems.filter(
  (project) => project.date instanceof Date,
);
const projectCandidates =
  datedProjects.length > 0 ? datedProjects : projectItems;
const recentProjects = selectRecentItems(projectCandidates);

const toastItems: ToastItem[] = [
  ...recentNotes.map((item) => ({ ...item, kind: "Writing" as const })),
  ...recentProjects.map((item) => ({ ...item, kind: "Project" as const })),
]
  .sort((a, b) => (b.date?.valueOf() ?? 0) - (a.date?.valueOf() ?? 0))
  .slice(0, MAX_TOASTS);

const hasToasts = toastItems.length > 0;
---

{
  hasToasts && (
    <aside
      class="recent-toast-wrapper"
      data-recent-updates
      aria-live="polite"
      aria-label="Latest updates"
    >
      <div class="recent-toast-header text-muted-text dark:text-dark-muted-text flex items-center gap-2 text-[11px] font-semibold tracking-[0.18em] uppercase">
        <span class="recent-toast-indicator" aria-hidden="true" />
        Recent Works
      </div>
      <div
        class="recent-toast-stack mt-2 flex flex-col"
        data-recent-toasts
        data-dismiss-after={AUTO_DISMISS_MS}
        data-stagger={STAGGER_MS}
      >
        {toastItems.map((item, index) => (
          <div
            class={`recent-toast ${
              item.kind === "Writing"
                ? "recent-toast--note"
                : "recent-toast--project"
            }`}
            style={`--toast-delay:${index * 0.12}s`}
            data-toast
          >
            <a
              href={item.href}
              class="recent-toast-link"
              target={item.kind === "Project" ? "_blank" : undefined}
              rel={item.kind === "Project" ? "noopener noreferrer" : undefined}
            >
              <span class="toast-dot" aria-hidden="true" />
              <div class="min-w-0">
                <p class="text-muted-text dark:text-dark-muted-text text-[10px] font-semibold tracking-[0.18em] uppercase">
                  {item.kind}
                </p>
                <p class="text-ink dark:text-dark-ink truncate text-sm font-medium">
                  {item.title}
                </p>
              </div>
              {item.isRecent && <span class="toast-pill">New</span>}
            </a>
            <button
              type="button"
              class="toast-close"
              data-toast-close
              aria-label="Dismiss"
            >
              &times;
            </button>
          </div>
        ))}
      </div>
    </aside>
  )
}

<style>
  .recent-toast-wrapper {
    position: fixed;
    top: auto;
    bottom: clamp(1.5rem, 4vw, 2.5rem);
    right: clamp(1rem, 3vw, 2rem);
    width: min(320px, 92vw);
    z-index: 40;
    pointer-events: none;
    font-family: var(--font-sans);
  }

  .recent-toast-stack {
    gap: 0.5rem;
  }

  .recent-toast {
    pointer-events: auto;
    position: relative;
    opacity: 0;
    transform: translateY(6px);
    animation: toast-in 0.35s ease forwards;
    animation-delay: var(--toast-delay);
    border: 1px solid var(--color-border);
    padding: 0.55rem 2.4rem 0.55rem 0.85rem;
    background: var(--color-surface);
    transition:
      opacity 0.35s ease,
      transform 0.35s ease,
      max-height 0.35s ease,
      margin 0.35s ease,
      padding 0.35s ease,
      border-color 0.35s ease;
    max-height: 86px;
    overflow: hidden;
  }

  :global(.dark) .recent-toast {
    border-color: var(--color-dark-border);
    background: var(--color-dark-surface);
  }

  .recent-toast:hover {
    border-color: var(--color-muted-text);
  }

  :global(.dark) .recent-toast:hover {
    border-color: var(--color-dark-muted-text);
  }

  .recent-toast-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 0;
    color: inherit;
    text-decoration: none;
  }

  .recent-toast.is-dismissing {
    opacity: 0;
    transform: translateY(-6px);
    max-height: 0;
    margin: 0;
    padding: 0;
    pointer-events: none;
    border-color: var(--color-bg);
  }

  :global(.dark) .recent-toast.is-dismissing {
    border-color: var(--color-dark-bg);
  }

  .recent-toast-indicator {
    width: 0.4rem;
    height: 0.4rem;
    background: var(--color-accent);
    display: inline-flex;
  }

  :global(.dark) .recent-toast-indicator {
    background: var(--color-dark-accent);
  }

  .toast-dot {
    width: 0.5rem;
    height: 0.5rem;
    flex: none;
  }

  .recent-toast--note .toast-dot {
    background: var(--color-accent);
  }

  .recent-toast--project .toast-dot {
    background: var(--color-accent-muted);
  }

  :global(.dark) .recent-toast--note .toast-dot {
    background: var(--color-dark-accent);
  }

  :global(.dark) .recent-toast--project .toast-dot {
    background: var(--color-dark-accent-muted);
  }

  .toast-pill {
    margin-left: auto;
    padding: 0.15rem 0.5rem;
    border: 1px solid var(--color-border);
    font-size: 0.55rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-weight: 600;
    background: var(--color-bg);
    color: var(--color-ink);
    flex: none;
  }

  :global(.dark) .toast-pill {
    background: var(--color-dark-bg);
    border-color: var(--color-dark-border);
    color: var(--color-dark-ink);
  }

  .toast-close {
    position: absolute;
    top: 50%;
    right: 0.6rem;
    transform: translateY(-50%) scale(0.9);
    opacity: 0;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    color: var(--color-muted-text);
    width: 1.6rem;
    height: 1.6rem;
    display: grid;
    place-items: center;
    font-size: 1rem;
    line-height: 1;
    cursor: pointer;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease,
      background-color 0.2s ease,
      border-color 0.2s ease;
  }

  :global(.dark) .toast-close {
    color: var(--color-dark-muted-text);
    border-color: var(--color-dark-border);
    background: var(--color-dark-bg);
  }

  .recent-toast:hover .toast-close,
  .recent-toast:focus-within .toast-close {
    opacity: 1;
    transform: translateY(-50%) scale(1);
  }

  .toast-close:hover {
    background: var(--color-surface);
    border-color: var(--color-muted-text);
  }

  :global(.dark) .toast-close:hover {
    background: var(--color-dark-surface);
    border-color: var(--color-dark-muted-text);
  }

  @keyframes toast-in {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 640px) {
    .recent-toast-wrapper {
      top: auto;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
      width: auto;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .recent-toast {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  const DISMISS_DURATION_MS = 420;

  const dismissToast = (
    toast: HTMLElement,
    toastStack: HTMLElement,
    container: HTMLElement,
  ) => {
    if (toast.dataset.dismissed === "true") return;
    toast.dataset.dismissed = "true";
    toast.classList.add("is-dismissing");
    window.setTimeout(() => {
      if (toast.isConnected) {
        toast.remove();
      }
      if (!toastStack.querySelector("[data-toast]")) {
        container.remove();
      }
    }, DISMISS_DURATION_MS);
  };

  const initRecentToasts = () => {
    const container = document.querySelector<HTMLElement>(
      "[data-recent-updates]",
    );
    if (!container || container.dataset.toastsInitialized === "true") return;
    container.dataset.toastsInitialized = "true";

    const toastStack = container.querySelector<HTMLElement>(
      "[data-recent-toasts]",
    );
    if (!toastStack) return;

    const dismissAfter = Number(
      toastStack.getAttribute("data-dismiss-after") || "9000",
    );
    const stagger = Number(toastStack.getAttribute("data-stagger") || "450");

    const toasts = Array.from(
      toastStack.querySelectorAll<HTMLElement>("[data-toast]"),
    );

    toastStack.addEventListener("click", (event: Event) => {
      const target = event.target as HTMLElement | null;
      const closeButton = target?.closest<HTMLElement>("[data-toast-close]");
      if (!closeButton) return;

      event.preventDefault();
      event.stopPropagation();

      const toast = closeButton.closest<HTMLElement>("[data-toast]");
      if (!toast) return;

      dismissToast(toast, toastStack, container);
    });

    toasts.forEach((toast, index) => {
      window.setTimeout(
        () => {
          dismissToast(toast, toastStack, container);
        },
        dismissAfter + index * stagger,
      );
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initRecentToasts);
  } else {
    initRecentToasts();
  }

  document.addEventListener("astro:page-load", initRecentToasts);
</script>
