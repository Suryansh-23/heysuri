---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Image } from "astro:assets";

import BaseLayout from "@/layouts/BaseLayout.astro";

import SeoPost from "@/components/SeoPost.astro";

import { formatDate } from "@/lib/util";

interface Props {
  entry: CollectionEntry<"notes">;
}

export async function getStaticPaths() {
  const notes = await getCollection("notes");
  return notes.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
---

<BaseLayout>
  <SeoPost slot="head" entry={entry} />
  <div>
    {
      entry.data.image && (
        <Image
          src={entry.data.image}
          alt={entry.data.imageAlt || ""}
          class="mb-12 h-auto w-full"
          draggable="false"
        />
      )
    }
    <h1
      class="text-[36px] leading-snug font-bold text-balance text-black dark:text-white"
    >
      {entry.data.title}
    </h1>
    <p class="text-muted-text dark:text-dark-muted-text mt-3">
      {formatDate(entry.data.publicationDate)}
    </p>
    <hr
      class="border-muted-text dark:border-dark-muted-text my-12 border-[0.5px] opacity-10 dark:opacity-15"
    />
    <div class="note-content prose mx-auto">
      <Content />
    </div>
    <hr
      class="border-muted-text dark:border-dark-muted-text my-32 border-[0.5px] opacity-10 dark:opacity-15"
    />
  </div>

  <style>
    .prose :global(.mermaid) {
      margin: 2rem 0;
      overflow-x: auto;
    }
  </style>

  <script>
    function updateNoteLinks() {
      document
        .querySelectorAll<HTMLAnchorElement>(".note-content a")
        .forEach((anchor) => {
          anchor.target = "_blank";
          const relValues = new Set(
            (anchor.getAttribute("rel") ?? "").split(" ").filter(Boolean),
          );
          relValues.add("noopener");
          relValues.add("noreferrer");
          anchor.setAttribute("rel", Array.from(relValues).join(" "));
        });
    }

    async function renderMermaidDiagrams() {
      const existingMermaidNodes = Array.from(
        document.querySelectorAll<HTMLElement>(".mermaid"),
      ).filter((node) => node.dataset.mermaidRendered !== "true");

      const mermaidFences = new Set<HTMLElement>();

      document
        .querySelectorAll<HTMLElement>(
          'pre[data-language="mermaid"], pre.language-mermaid',
        )
        .forEach((node) => mermaidFences.add(node));

      document
        .querySelectorAll<HTMLElement>("code.language-mermaid")
        .forEach((node) => {
          const pre = node.closest("pre");
          if (pre) mermaidFences.add(pre);
        });

      const convertedNodes: HTMLElement[] = [];
      for (const pre of mermaidFences) {
        if (pre.dataset.mermaidConverted === "true") continue;

        const source = pre.textContent ?? "";
        if (!source.trim()) continue;

        const wrapper = document.createElement("div");
        wrapper.className = "mermaid";
        wrapper.textContent = source;
        pre.dataset.mermaidConverted = "true";
        pre.replaceWith(wrapper);
        convertedNodes.push(wrapper);
      }

      const nodesToRender: HTMLElement[] = [
        ...existingMermaidNodes,
        ...convertedNodes,
      ].filter((node) => node.dataset.mermaidRendered !== "true");

      if (nodesToRender.length === 0) return;

      const { default: mermaid } = await import("mermaid");
      const isDark = document.documentElement.classList.contains("dark");

      mermaid.initialize({
        startOnLoad: false,
        securityLevel: "strict",
        theme: isDark ? "dark" : "default",
      });

      await mermaid.run({ nodes: nodesToRender });
      nodesToRender.forEach((node) => {
        node.dataset.mermaidRendered = "true";
      });
    }

    async function handleContentReady() {
      updateNoteLinks();
      await renderMermaidDiagrams();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        void handleContentReady();
      });
    } else {
      void handleContentReady();
    }

    document.addEventListener("astro:page-load", () => {
      void handleContentReady();
    });
  </script>
</BaseLayout>
