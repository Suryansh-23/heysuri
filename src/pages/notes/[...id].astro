---
import { type CollectionEntry, getCollection, render } from "astro:content";
import { Image } from "astro:assets";

import BaseLayout from "@/layouts/BaseLayout.astro";

import SeoPost from "@/components/SeoPost.astro";
import ShareButton from "@/components/ShareButton.astro";

import { formatDate } from "@/lib/util";

interface Props {
  entry: CollectionEntry<"notes">;
}

export async function getStaticPaths() {
  const notes = await getCollection("notes");
  return notes.map((entry) => ({
    params: { id: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);
---

<BaseLayout>
  <SeoPost slot="head" entry={entry} />
  <div>
    {
      entry.data.image && (
        <Image
          src={entry.data.image}
          alt={entry.data.imageAlt || ""}
          class="mb-12 h-auto w-full"
          draggable="false"
        />
      )
    }
    <h1
      class="text-ink dark:text-dark-ink text-[36px] leading-snug font-bold text-balance"
    >
      {entry.data.title}
    </h1>
    <div class="mt-3 flex flex-wrap items-center gap-3">
      <p
        class="text-muted-text dark:text-dark-muted-text m-0 flex items-center leading-none self-stretch"
      >
        {formatDate(entry.data.publicationDate)}
      </p>
      <ShareButton class="ml-auto" />
    </div>
    <hr class="border-border dark:border-dark-border my-12 border-[0.5px]" />
    <div class="note-content prose mx-auto">
      <Content />
    </div>
    <div class="mt-16 flex items-center justify-end">
      <ShareButton />
    </div>
    <hr class="border-border dark:border-dark-border my-32 border-[0.5px]" />
  </div>

  <style>
    .note-content :global(.mermaid) {
      margin: 2rem 0;
      overflow-x: auto;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      padding: clamp(0.75rem, 1.6vw, 1rem);
      cursor: zoom-in;
    }

    :global(.dark) .note-content :global(.mermaid) {
      background: var(--color-dark-surface);
      border-color: var(--color-dark-border);
    }

    .note-content :global(img),
    .note-content :global(picture img) {
      cursor: zoom-in;
    }

    :global(.media-viewer) {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 3vw, 2rem);
      background: var(--color-bg);
      color: var(--color-ink);
      z-index: 60;
      cursor: zoom-out;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition:
        opacity 0.2s ease,
        visibility 0s linear 0.2s;
    }

    :global(.dark .media-viewer) {
      background: var(--color-dark-bg);
      color: var(--color-dark-ink);
    }

    :global(.media-viewer.is-open) {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transition: opacity 0.2s ease;
    }

    :global(.media-viewer__dialog) {
      width: min(1100px, 92vw);
      max-height: 90vh;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 0.75rem;
      padding: clamp(0.75rem, 2vw, 1rem);
      cursor: default;
      transform: translateY(6px);
      opacity: 0;
      transition:
        transform 0.2s ease,
        opacity 0.2s ease;
    }

    :global(.media-viewer.is-open .media-viewer__dialog) {
      transform: translateY(0);
      opacity: 1;
    }

    :global(.dark .media-viewer__dialog) {
      background: var(--color-dark-surface);
      border-color: var(--color-dark-border);
    }

    :global(.media-viewer__header) {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: var(--font-sans);
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.65rem;
      color: var(--color-muted-text);
    }

    :global(.dark .media-viewer__header) {
      color: var(--color-dark-muted-text);
    }

    :global(.media-viewer__body) {
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }

    :global(.media-viewer__body img) {
      max-width: 100%;
      height: auto;
      display: block;
    }

    :global(.media-viewer__body .mermaid) {
      margin: 0;
      padding: 0;
      border: none;
      background: inherit;
      cursor: default;
      width: 100%;
    }

    :global(.media-viewer__close) {
      border: 1px solid var(--color-border);
      background: var(--color-bg);
      color: var(--color-muted-text);
      font-family: var(--font-sans);
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 0.3rem 0.65rem;
      cursor: pointer;
    }

    :global(.dark .media-viewer__close) {
      border-color: var(--color-dark-border);
      background: var(--color-dark-bg);
      color: var(--color-dark-muted-text);
    }

    @media (prefers-reduced-motion: reduce) {
      :global(.media-viewer) {
        transition: none;
      }

      :global(.media-viewer__dialog) {
        transition: none;
      }
    }
  </style>

  <script>
    function updateNoteLinks() {
      document
        .querySelectorAll<HTMLAnchorElement>(".note-content a")
        .forEach((anchor) => {
          anchor.target = "_blank";
          const relValues = new Set(
            (anchor.getAttribute("rel") ?? "").split(" ").filter(Boolean),
          );
          relValues.add("noopener");
          relValues.add("noreferrer");
          anchor.setAttribute("rel", Array.from(relValues).join(" "));
        });
    }

    function initShareButtons() {
      const buttons = document.querySelectorAll<HTMLButtonElement>(
        "[data-share-button]",
      );
      if (!buttons.length) return;

      const timeoutMap = new WeakMap<Element, number>();

      const setShareState = (
        button: HTMLButtonElement,
        state: "copied" | "error",
        message: string,
      ) => {
        const status = button.querySelector<HTMLElement>("[data-share-status]");
        if (status) status.textContent = message;
        button.dataset.shareState = state;
        const existingTimeout = timeoutMap.get(button);
        if (existingTimeout) {
          window.clearTimeout(existingTimeout);
        }
        const timeout = window.setTimeout(() => {
          button.dataset.shareState = "idle";
          if (status) status.textContent = "";
        }, 2400);
        timeoutMap.set(button, timeout);
      };

      const copyText = async (text: string) => {
        if (navigator.clipboard?.writeText && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }

        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        const succeeded = document.execCommand("copy");
        document.body.removeChild(textarea);
        return succeeded;
      };

      const fallbackPrompt = (text: string) => {
        window.prompt("Copy link:", text);
      };

      buttons.forEach((button) => {
        if (button.dataset.shareBound === "true") return;
        button.dataset.shareBound = "true";
        button.addEventListener("click", async () => {
          try {
            const url = window.location.href;
            const copied = await copyText(url);
            if (copied) {
              setShareState(button, "copied", "Link copied");
            } else {
              fallbackPrompt(url);
              setShareState(button, "copied", "Link ready");
            }
          } catch {
            fallbackPrompt(window.location.href);
            setShareState(button, "copied", "Link ready");
          }
        });
      });
    }

    async function renderMermaidDiagrams() {
      const existingMermaidNodes = Array.from(
        document.querySelectorAll<HTMLElement>(".mermaid"),
      ).filter((node) => node.dataset.mermaidRendered !== "true");

      const mermaidFences = new Set<HTMLElement>();

      document
        .querySelectorAll<HTMLElement>(
          'pre[data-language="mermaid"], pre.language-mermaid',
        )
        .forEach((node) => mermaidFences.add(node));

      document
        .querySelectorAll<HTMLElement>("code.language-mermaid")
        .forEach((node) => {
          const pre = node.closest("pre");
          if (pre) mermaidFences.add(pre);
        });

      const convertedNodes: HTMLElement[] = [];
      for (const pre of mermaidFences) {
        if (pre.dataset.mermaidConverted === "true") continue;

        const source = pre.textContent ?? "";
        if (!source.trim()) continue;

        const wrapper = document.createElement("div");
        wrapper.className = "mermaid";
        wrapper.textContent = source;
        pre.dataset.mermaidConverted = "true";
        pre.replaceWith(wrapper);
        convertedNodes.push(wrapper);
      }

      const nodesToRender: HTMLElement[] = [
        ...existingMermaidNodes,
        ...convertedNodes,
      ].filter((node) => node.dataset.mermaidRendered !== "true");

      if (nodesToRender.length === 0) return;

      const { default: mermaid } = await import("mermaid");
      const isDark = document.documentElement.classList.contains("dark");

      mermaid.initialize({
        startOnLoad: false,
        securityLevel: "strict",
        theme: isDark ? "dark" : "default",
      });

      await mermaid.run({ nodes: nodesToRender });
      nodesToRender.forEach((node) => {
        node.dataset.mermaidRendered = "true";
      });
    }

    function initMediaViewer() {
      const content = document.querySelector<HTMLElement>(".note-content");
      if (!content || content.dataset.mediaPreviewInitialized === "true") {
        return;
      }
      content.dataset.mediaPreviewInitialized = "true";

      let viewer = document.querySelector<HTMLElement>("[data-media-viewer]");
      if (!viewer) {
        viewer = document.createElement("div");
        viewer.className = "media-viewer";
        viewer.dataset.mediaViewer = "true";
        viewer.setAttribute("aria-hidden", "true");
        viewer.setAttribute("role", "dialog");
        viewer.setAttribute("aria-modal", "true");
        viewer.innerHTML = `
          <div class="media-viewer__dialog" role="document">
            <div class="media-viewer__header">
              <span>Preview</span>
              <button class="media-viewer__close" type="button" data-media-close>
                Close
              </button>
            </div>
            <div class="media-viewer__body" data-media-body></div>
          </div>
        `;
        document.body.appendChild(viewer);
      }

      const body = viewer.querySelector<HTMLElement>("[data-media-body]");

      const VIEWER_FADE_MS = 200;
      let closeTimeout: number | undefined;

      const closeViewer = () => {
        if (!viewer || !body) return;
        if (!viewer.classList.contains("is-open")) return;
        viewer.classList.remove("is-open");
        window.clearTimeout(closeTimeout);
        closeTimeout = window.setTimeout(() => {
          viewer.setAttribute("aria-hidden", "true");
          body.innerHTML = "";
          document.documentElement.style.overflow = "";
        }, VIEWER_FADE_MS);
      };

      const openViewer = (node: HTMLElement) => {
        if (!viewer || !body) return;
        body.innerHTML = "";

        if (node instanceof HTMLImageElement) {
          const previewImage = new Image();
          previewImage.src = node.currentSrc || node.src;
          previewImage.alt = node.alt || "";
          body.appendChild(previewImage);
        } else {
          const clone = node.cloneNode(true) as HTMLElement;
          body.appendChild(clone);
        }

        viewer.classList.add("is-open");
        viewer.setAttribute("aria-hidden", "false");
        window.clearTimeout(closeTimeout);
        document.documentElement.style.overflow = "hidden";
      };

      if (viewer.dataset.mediaListenersAttached !== "true") {
        viewer.dataset.mediaListenersAttached = "true";

        viewer.addEventListener("click", (event) => {
          const target = event.target as HTMLElement | null;
          if (!target) return;
          if (target.closest("[data-media-close]") || target === viewer) {
            closeViewer();
          }
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && viewer?.classList.contains("is-open")) {
            closeViewer();
          }
        });
      }

      content.addEventListener("click", (event) => {
        const target = event.target as HTMLElement | null;
        if (!target) return;

        const mermaidNode = target.closest<HTMLElement>(".mermaid");
        if (mermaidNode && content.contains(mermaidNode)) {
          event.preventDefault();
          event.stopPropagation();
          openViewer(mermaidNode);
          return;
        }

        const imageNode = target.closest<HTMLImageElement>("img");
        if (imageNode && content.contains(imageNode)) {
          event.preventDefault();
          event.stopPropagation();
          openViewer(imageNode);
        }
      });
    }

    async function handleContentReady() {
      updateNoteLinks();
      initShareButtons();
      try {
        await renderMermaidDiagrams();
      } catch {}
      initMediaViewer();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        void handleContentReady();
      });
    } else {
      void handleContentReady();
    }

    document.addEventListener("astro:page-load", () => {
      void handleContentReady();
    });
  </script>
</BaseLayout>
